name: Publish Website

on:
  push:
    branches:
      - master
    paths:
      - "**.php"
      - "src/**"
      - "dist/**"
      - "assets/**"
      - "template-parts/**"
      - "inc/**"
      - "style.css"
      - "gulpfile.js"
      - "package.json"
      - "yarn.lock"

jobs:
  web-deploy:
    name: ğŸš€ Deploy Website Every Commit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸšš Get Latest Code
        uses: actions/checkout@v3

      - name: ğŸ”§ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      # ---------------------------------------------
      # ğŸ§¶ Use Yarn 4.9.2 (same as local)
      # ---------------------------------------------
      - name: ğŸ§¶ Enable Yarn 4.9.2 via Corepack
        run: corepack prepare yarn@4.9.2 --activate

      - name: ğŸ“¦ Verify Yarn version
        run: yarn --version

      # ---------------------------------------------
      # âš¡ï¸ Cache Yarn 4 dependencies
      # ---------------------------------------------
      - name: â™»ï¸ Cache Yarn 4 Offline Cache
        uses: actions/cache@v3
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: yarn4-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            yarn4-

      # ---------------------------------------------
      # ğŸ“¥ Install dependencies (fast with cache)
      # ---------------------------------------------
      - name: ğŸ“¥ Install Dependencies
        run: yarn install --immutable

      # ---------------------------------------------
      # ğŸ›  Build assets
      # ---------------------------------------------
      - name: ğŸ›  Build Assets
        run: yarn gulp build

      # ---------------------------------------------
      # ğŸš€ Deploy
      # ---------------------------------------------
      - name: ğŸš€ Deploy Theme
        uses: SamKirkland/web-deploy@v1
        with:
          target-server: elideproperty.co.zw
          remote-user: elidepro
          private-ssh-key: ${{ secrets.SSH_KEY }}
          destination-path: /home/elidepro/elideproperty.co.zw/public_html/wp-content/themes/crafted-theme/
          ssh-port: 65002
          source-path: ./
          exclude: |
            **/node_modules/**
            **/.git/**
            **/.github/**
            **/src/**
            **/.editorconfig
            **/.gitignore
            **/package.json
            **/yarn.lock
            **/gulpfile.js
          dangerously-clean-slate: true
